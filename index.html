<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта «интересных мест» — рельеф + спутник + топо + POI (v2)</title>

  <!-- Leaflet (официальные SRI) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; background:#e6e7e9; }
    .legend {
      position:absolute; right:12px; top:12px; z-index:1000;
      background:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
      font:13px/1.35 system-ui, -apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      max-width:260px;
    }
    .legend .bar { width:18px; height:260px; border-radius:6px; background:linear-gradient(to top,
      #1f78b4,#2ca25f,#fee08b,#fdae61,#d73027); margin-right:10px; }
    .legend .row { display:flex; align-items:center; }
    .legend .ticks { margin-left:8px; }
    .legend .ticks div { height:26px; display:flex; align-items:center; }
    .badge {
      position:absolute; left:12px; bottom:12px; z-index:1000;
      background:rgba(255,255,255,.9); padding:6px 10px; border-radius:10px; font-size:12px;
    }
    .leaflet-popup-content { margin:8px 12px; }
    .ctrl-box {
      background:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.15);
      font:13px/1.35 system-ui, -apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      max-width:340px;
    }
    .ctrl-box label { user-select:none; display:flex; gap:6px; align-items:center; }
    .grp { margin-top:8px; }
    .grp b { display:block; margin-bottom:4px; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:6px 14px; }
    .blend-multiply { mix-blend-mode: multiply; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend" id="legend">
    <div><b>Высота</b></div>
    <div class="row">
      <div class="bar"></div>
      <div class="ticks" id="ticks"></div>
    </div>
    <div id="range" style="margin-top:6px;color:#555"></div>
  </div>

  <div class="badge">Рельеф: Terrarium (Mapzen) · База: © OpenStreetMap / Esri / OpenTopoMap · Тени: WMF Labs · Тропы: Waymarked · Landcover: ESA/EOX</div>

<script>
/* ================= ПАРАМЕТРЫ ================= */
const qs = new URLSearchParams(location.search);
const center = (qs.get("center") || "54.02713,22.26345").split(",").map(Number);
const zoom   = Number(qs.get("zoom") || 11);
let   locked = qs.get("lock") === '1';
let   EMIN   = Number(qs.get("emin") || 0);
let   EMAX   = Number(qs.get("emax") || 400);
let   base   = (qs.get("base") === 'sat') ? 'sat' : (qs.get("base")==='topo'?'topo':'osm');

/* ================= КАРТА и БАЗЫ ================= */
const map = L.map('map', { zoomControl: true }).setView(center, zoom);

const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: '&copy; OpenStreetMap contributors', zIndex: 1
});

const esri = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Imagery © Esri — Sources: Esri, Maxar, Earthstar Geographics, USDA, USGS, AeroGRID, IGN, and the GIS User Community', zIndex: 1 }
);

const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)', zIndex: 1
});

function setBase(v){
  [osm, esri, topo].forEach(l => map.removeLayer(l));
  if (v==='sat') esri.addTo(map); else if (v==='topo') topo.addTo(map); else osm.addTo(map);
}
setBase(base);

/* ================= ЦВЕТА РЕЛЬЕФА ================= */
function lerp(a,b,t){ return a + (b-a)*t; }
function mix(c1,c2,t){ return [Math.round(lerp(c1[0],c2[0],t)), Math.round(lerp(c1[1],c2[1],t)), Math.round(lerp(c1[2],c2[2],t))]; }
const stops = [
  {t:0.00, c:[ 31,120,180]},
  {t:0.35, c:[ 44,162, 95]},
  {t:0.60, c:[254,224,139]},
  {t:0.80, c:[253,174, 97]},
  {t:1.00, c:[215, 48, 39]},
];
function colorFor(e, emin, emax){
  if (emax <= emin) return stops[stops.length-1].c;
  let t = (e - emin) / (emax - emin);
  if (t <= 0) return stops[0].c;
  if (t >= 1) return stops[stops.length-1].c;
  for (let i=0;i<stops.length-1;i++){
    const a = stops[i], b = stops[i+1];
    if (t >= a.t && t <= b.t){ const u = (t - a.t) / (b.t - a.t); return mix(a.c, b.c, u); }
  }
  return stops[stops.length-1].c;
}

/* ================= TERRARIUM РЕЛЬЕФ ================= */
const terrariumURL = (z,x,y) => `https://elevation-tiles-prod.s3.amazonaws.com/terrarium/${z}/${x}/${y}.png`;
const rawTiles = new Map();   // key -> Uint8ClampedArray (RGBA исходные пиксели)
const tileStats = new Map();  // key -> {min,max}
const tileCtx   = new Map();  // key -> CanvasRenderingContext2D

const TerrariumLayer = L.GridLayer.extend({
  createTile: function (coords) {
    const tile = L.DomUtil.create('canvas', 'leaflet-tile'); tile.width = tile.height = 256; const ctx = tile.getContext('2d');
    const img = new Image(); img.crossOrigin = "anonymous"; img.referrerPolicy = "no-referrer"; img.src = terrariumURL(coords.z, coords.x, coords.y);
    const key = `${coords.z}/${coords.x}/${coords.y}`;
    img.onload = () => {
      try {
        ctx.drawImage(img, 0, 0); const imgData = ctx.getImageData(0,0,256,256); const src = imgData.data;
        let tmin = Infinity, tmax = -Infinity;
        for (let i=0;i<src.length;i+=4){ const R=src[i], G=src[i+1], B=src[i+2]; const elev=(R*256+G+B/256)-32768; if (elev<tmin) tmin=elev; if (elev>tmax) tmax=elev; }
        rawTiles.set(key, new Uint8ClampedArray(src)); tileStats.set(key, {min:tmin, max:tmax}); tileCtx.set(key, ctx);
        recolorTile(key, EMIN, EMAX); scheduleRecolor();
      } catch (e) { console.warn('Terrarium decode failed:', e, key); ctx.clearRect(0,0,256,256); }
    };
    img.onerror = err => { console.warn('Terrarium tile error:', key, err); ctx.clearRect(0,0,256,256); };
    return tile;
  }
});
const reliefLayer = new TerrariumLayer({ opacity: 0.67 }); reliefLayer.addTo(map); reliefLayer.setZIndex(6);
reliefLayer.on('tileunload', (ev)=>{ const key = `${ev.coords.z}/${ev.coords.x}/${ev.coords.y}`; rawTiles.delete(key); tileStats.delete(key); tileCtx.delete(key); });

/* ================= ДОП. ОВЕРЛЕИ ================= */
// Теневой рельеф (черно-белый), сверху базы, но под цветовым рельефом. Бленд: multiply.
const hillshade = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
  opacity: 0.6, zIndex: 5, className: 'blend-multiply',
  attribution: 'Hillshade: SRTM/ASTER — WMF Labs'
});

// Сеть пешеходных маршрутов (красные линии), поверх всего
const waymarked = L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', {
  opacity: 1.0, zIndex: 10,
  attribution: 'Waymarked Trails (CC BY-SA) — hiking routes overlay'
});

// Типы покрытий (Landcover) — под цветовым рельефом
const landcover = L.tileLayer('https://tiles.maps.eox.at/wmts/1.0.0/WORLDCOVER_2021_19class/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
  opacity: 0.45, zIndex: 4,
  attribution: 'ESA WorldCover 2021 via EOX (CC BY 4.0)'
});

/* ================= РЕМЕП ПО ВЬЮПОРТУ ================= */
function visibleTileKeys(){ const z = map.getZoom(); const size=256, scale=1<<z; const b = map.getPixelBounds();
  const minX=Math.floor(b.min.x/size), maxX=Math.floor(b.max.x/size); const minY=Math.floor(b.min.y/size), maxY=Math.floor(b.max.y/size);
  const keys=[]; for (let x=minX;x<=maxX;x++){ for (let y=minY;y<=maxY;y++){ const xx=((x%scale)+scale)%scale; const yy=Math.min(Math.max(y,0),scale-1); keys.push(`${z}/${xx}/${yy}`); }} return keys; }
function computeViewportRange(){ const keys = visibleTileKeys(); let vmin=Infinity, vmax=-Infinity, have=false;
  for (const k of keys){ const st = tileStats.get(k); if (!st) continue; have=true; if (st.min<vmin) vmin=st.min; if (st.max>vmax) vmax=st.max; }
  if (!have) return null; return {min:vmin, max:vmax}; }
function recolorTile(key, emin, emax){ const raw=rawTiles.get(key), ctx=tileCtx.get(key); if(!raw||!ctx) return; const imgData=ctx.createImageData(256,256); const dst=imgData.data;
  for (let i=0;i<raw.length;i+=4){ const R=raw[i], G=raw[i+1], B=raw[i+2]; const elev=(R*256+G+B/256)-32768; const [r,g,b]=colorFor(elev, EMIN, EMAX); dst[i]=r; dst[i+1]=g; dst[i+2]=b; dst[i+3]=170; }
  ctx.putImageData(imgData, 0, 0); }
function recolorVisible(){ if (!locked){ const range=computeViewportRange(); if (range){ EMIN=range.min; EMAX=range.max; updateLegend(); } } for (const k of visibleTileKeys()) recolorTile(k, EMIN, EMAX); }
let recolorTimer=null; function scheduleRecolor(){ if (recolorTimer) cancelAnimationFrame(recolorTimer); recolorTimer=requestAnimationFrame(recolorVisible); }
map.on('moveend zoomend', scheduleRecolor); scheduleRecolor();

/* ================= ВЫСОТА ПО КЛИКУ ================= */
function elevAtLatLng(latlng){ const z=map.getZoom(); const world=map.project(latlng,z); const tileX=Math.floor(world.x/256), tileY=Math.floor(world.y/256); const px=Math.floor(world.x)%256, py=Math.floor(world.y)%256; const key=`${z}/${tileX}/${tileY}`; const data=rawTiles.get(key); if(!data)return null; const i=(py*256+px)*4; const R=data[i],G=data[i+1],B=data[i+2]; return (R*256+G+B/256)-32768; }
map.on('click', (e)=>{ const elev=elevAtLatLng(e.latlng); const m=L.marker(e.latlng).addTo(map); if(elev==null){ m.bindPopup('Высота недоступна: тайл ещё грузится.').openPopup(); return; } m.bindPopup(`<b>Высота:</b> ${elev.toFixed(1)} м<br>Шир.: ${e.latlng.lat.toFixed(6)}<br>Долг.: ${e.latlng.lng.toFixed(6)}`).openPopup(); });

/* ================= ЛЕГЕНДА ================= */
function updateLegend(){ document.getElementById('range').textContent = `${Math.round(EMIN)} м  →  ${Math.round(EMAX)} м`; const ticks=document.getElementById('ticks'); const steps=10, stepVal=(EMAX-EMIN)/steps; ticks.innerHTML=''; for (let i=steps;i>=0;i--){ const v=Math.round(EMIN+stepVal*i); const div=document.createElement('div'); div.textContent=`${v} м`; ticks.appendChild(div);} }
updateLegend();

/* ================= POI (Overpass) ================= */
const POI_CFG = {
  peaks:       { color:'#d73027', label:'Пики',        filter:(t)=> t.natural==='peak' },
  viewpoints:  { color:'#7b3294', label:'Видовые',     filter:(t)=> t.tourism==='viewpoint' },
  springs:     { color:'#1f78b4', label:'Родники',     filter:(t)=> t.natural==='spring' },
  waterfalls:  { color:'#225ea8', label:'Водопады',    filter:(t)=> t.waterway==='waterfall' },
  caves:       { color:'#4b4b4b', label:'Пещеры',      filter:(t)=> t.natural==='cave_entrance' },
  ruins:       { color:'#b2182b', label:'Руины/замки', filter:(t)=> t.historic==='ruins' || t.historic==='castle' || t.historic==='fort' || t.historic==='archaeological_site' },
  towers:      { color:'#fdae61', label:'Башни',       filter:(t)=> t.man_made==='tower' }
};
const poiLayers = Object.fromEntries(Object.keys(POI_CFG).map(k=>[k, L.layerGroup()]));
Object.values(poiLayers).forEach(g=>g.setZIndex && g.setZIndex(11));
let poiEnabled = true;

function bboxString(b){ return `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`; }
let poiReq = 0;
async function loadPOI(){ if (!poiEnabled) return; const b = map.getBounds(); const bbox = bboxString(b);
  const q = `[out:json][timeout:25];(node["natural"="peak"](${bbox});node["tourism"="viewpoint"](${bbox});node["natural"="spring"](${bbox});node["waterway"="waterfall"](${bbox});node["natural"="cave_entrance"](${bbox});node["historic"~"castle|ruins|fort|archaeological_site"](${bbox});node["man_made"="tower"](${bbox}););out body;`;
  const id = ++poiReq; try{ const res = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}, body: new URLSearchParams({ data: q }) }); const json = await res.json(); if (id !== poiReq) return; for (const k in poiLayers) poiLayers[k].clearLayers(); (json.elements||[]).forEach(el => { if (el.type !== 'node') return; const lat=el.lat, lon=el.lon, tags=el.tags||{}; for (const k in POI_CFG){ if (POI_CFG[k].filter(tags)){ L.circleMarker([lat,lon], { radius:5, weight:1, color:'#000', opacity:0.6, fillColor:POI_CFG[k].color, fillOpacity:0.95 }).bindPopup(`<b>${tags.name||POI_CFG[k].label}</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}`).addTo(poiLayers[k]); break; } } }); }catch(e){ console.warn('Overpass error', e); } }
let poiTimer=null; function schedulePOI(){ if (!poiEnabled) return; if (poiTimer) clearTimeout(poiTimer); poiTimer = setTimeout(loadPOI, 600); }
map.on('moveend zoomend', schedulePOI); schedulePOI();

/* ================= КОНТРОЛЫ ================= */
const ToggleCtrl = L.Control.extend({ onAdd: function(){ const div = L.DomUtil.create('div','ctrl-box'); div.innerHTML = `
  <div class=\"grp\">
    <b>База</b>
    <div class=\"cols\">
      <label><input type=\"radio\" name=\"base\" value=\"osm\" ${base==='osm'?'checked':''}> Карта</label>
      <label><input type=\"radio\" name=\"base\" value=\"sat\" ${base==='sat'?'checked':''}> Спутник</label>
      <label><input type=\"radio\" name=\"base\" value=\"topo\" ${base==='topo'?'checked':''}> Топо</label>
    </div>
  </div>
  <div class=\"grp\">
    <b>Оверлеи</b>
    <div class=\"cols\">
      <label><input type=\"checkbox\" id=\"relief-toggle\" checked> Рельеф (заливка)</label>
      <label style=\"grid-column:span 2\">Прозрачность: <input type=\"range\" id=\"relief-opacity\" min=\"0\" max=\"1\" step=\"0.05\" value=\"0.67\" style=\"width:160px\"></label>
      <label><input type=\"checkbox\" id=\"hill-toggle\"> Теневой рельеф</label>
      <label><input type=\"checkbox\" id=\"trail-toggle\"> Тропы/маршруты</label>
      <label><input type=\"checkbox\" id=\"land-toggle\"> Типы покрытий</label>
    </div>
  </div>
  <div class=\"grp\">
    <b>POI (точки интереса)</b>
    <div class=\"cols\">
      <label><input type=\"checkbox\" id=\"poi-master\" checked> Включить</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"peaks\" checked> Пики</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"viewpoints\" checked> Видовые</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"springs\" checked> Родники</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"waterfalls\" checked> Водопады</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"caves\" checked> Пещеры</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"ruins\" checked> Руины/замки</label>
      <label><input type=\"checkbox\" class=\"poi-cat\" data-k=\"towers\" checked> Башни</label>
    </div>
  </div>
  <div class=\"grp\">
    <b>Диапазон</b>
    <label><input type=\"checkbox\" id=\"lock-toggle\" ${locked? 'checked':''}> Фиксировать min/max</label>
  </div>`; L.DomEvent.disableClickPropagation(div); return div; }});
map.addControl(new ToggleCtrl({ position: 'topleft' }));

Array.from(document.querySelectorAll('input[name="base"]')).forEach(r => r.addEventListener('change', (e)=> setBase(e.target.value)));

document.getElementById('relief-toggle').addEventListener('change', (e)=>{ reliefLayer.setOpacity(e.target.checked ? parseFloat(document.getElementById('relief-opacity').value) : 0); });
document.getElementById('relief-opacity').addEventListener('input', (e)=>{ reliefLayer.setOpacity(parseFloat(e.target.value)); });

document.getElementById('hill-toggle').addEventListener('change', (e)=>{ if (e.target.checked) hillshade.addTo(map); else map.removeLayer(hillshade); });
document.getElementById('trail-toggle').addEventListener('change', (e)=>{ if (e.target.checked) waymarked.addTo(map); else map.removeLayer(waymarked); });
document.getElementById('land-toggle').addEventListener('change', (e)=>{ if (e.target.checked) landcover.addTo(map); else map.removeLayer(landcover); });

document.getElementById('poi-master').addEventListener('change', (e)=>{ poiEnabled = e.target.checked; if (poiEnabled){ schedulePOI(); for (const k in poiLayers) { const on = document.querySelector(`.poi-cat[data-k="${k}"]`).checked; if (on && !map.hasLayer(poiLayers[k])) poiLayers[k].addTo(map); } } else { for (const k in poiLayers) map.removeLayer(poiLayers[k]); } });
Array.from(document.querySelectorAll('.poi-cat')).forEach(cb => cb.addEventListener('change', (e)=>{ const k = e.target.dataset.k; if (!k || !poiEnabled) return; if (e.target.checked) { if (!map.hasLayer(poiLayers[k])) poiLayers[k].addTo(map); } else { map.removeLayer(poiLayers[k]); } }));
for (const k in poiLayers){ const on = document.querySelector(`.poi-cat[data-k="${k}"]`).checked; if (on) poiLayers[k].addTo(map); }

document.getElementById('lock-toggle').addEventListener('change', (e)=>{ locked = e.target.checked; scheduleRecolor(); });
</script>
</body>
</html>
